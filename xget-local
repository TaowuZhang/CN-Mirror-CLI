#!/usr/bin/env bash
set -euo pipefail

# xget-local – 仅使用国内镜像的本地真实使用版本
# 不依赖 Cloudflare Worker；优先 GHProxy，其次直接回源；克隆使用 gitclone 重写

# 配置文件加载（默认同目录 xget.conf，但不使用 XGET_PREFIX）
XGET_CONF_PATH="${XGET_CONF_PATH:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/xget.conf}"
if [[ -f "$XGET_CONF_PATH" ]]; then
  # shellcheck disable=SC1090
  source "$XGET_CONF_PATH"
# 额外加载自动生成的镜像配置（由 refresh_mirrors.sh 生成）
MIRRORS_CONF_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/mirrors.conf"
if [[ -f "$MIRRORS_CONF_PATH" ]]; then
  source "$MIRRORS_CONF_PATH"
fi
fi

function log() { echo "[$(date '+%H:%M:%S')] $*"; }

if ! declare -p GH_PROXY_LIST >/dev/null 2>&1; then
GH_PROXY_LIST=(
  "https://mirror.ghproxy.com/"
  "https://cf.ghproxy.cc/"
  "https://gh-proxy.com/"
  "https://v6.gh-proxy.com/"
  "https://gh.api.99988866.xyz/"
  "https://ghproxy.1888866.xyz/"
  "https://gh.ddlc.top/"
)
fi

BOTTLE_MIRRORS_TUNA="https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles"
BOTTLE_MIRRORS_USTC="https://mirrors.ustc.edu.cn/homebrew-bottles"
BOTTLE_MIRRORS_BFSU="https://mirrors.bfsu.edu.cn/homebrew-bottles"

BREW_GIT_TUNA="https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git"
CORE_GIT_TUNA="https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git"
BREW_GIT_USTC="https://mirrors.ustc.edu.cn/homebrew/brew.git"
CORE_GIT_USTC="https://mirrors.ustc.edu.cn/homebrew/homebrew-core.git"
BREW_GIT_BFSU="https://mirrors.bfsu.edu.cn/homebrew/brew.git"
CORE_GIT_BFSU="https://mirrors.bfsu.edu.cn/homebrew/homebrew-core.git"

function _proxy_url() {
  local prefix="$1"; local url="$2"
  printf "%s%s" "$prefix" "$url"
}

function xget_download() {
  if [[ $# -lt 1 ]]; then
    echo "Usage: xget_download <url> [dest]"
    return 2
  fi
  local url="$1"
  local dest="${2:-}"
  if [[ -z "$dest" ]]; then
    dest="$(basename "${url%%\?*}")"
    [[ -z "$dest" || "$dest" == "/" ]] && dest="download.bin"
  fi
  local tried=()
  local prefixes=()
  prefixes+=("${GH_PROXY_LIST[@]}")
  prefixes+=("")
  for p in "${prefixes[@]}"; do
    local try_url="$url"
    if [[ -n "$p" ]]; then try_url="$(_proxy_url "$p" "$url")"; fi
    tried+=("$try_url")
    log "GET $try_url -> $dest"
    if curl -fL --connect-timeout 10 --retry 3 --retry-delay 1 -o "$dest" "$try_url"; then
      log "OK: $dest"; return 0
    else
      log "FAIL: $try_url"
    fi
  done
  log "All attempts failed:"; printf '%s\n' "${tried[@]}" >&2; return 1
}

function xget_clone() {
  if [[ $# -lt 1 ]]; then
    echo "Usage: xget_clone <https_repo_url> [args...]"; return 2
  fi
  local repo="$1"; shift || true
  local mirror_repo
  mirror_repo="${repo/https:\/\/github.com\//https:\/\/gitclone.com\/github.com\/}"
  log "git clone $mirror_repo $*"
  GIT_TRACE=1 git clone "$mirror_repo" "$@"
}

function set_git_mirror() {
  local scheme="${1:-gitclone}"
  case "$scheme" in
    gitclone)
      git config --global url."https://gitclone.com/github.com/".insteadof "https://github.com/"
      log "Git mirror set: github.com -> gitclone.com/github.com/";;
    ghproxy)
      git config --global url."https://mirror.ghproxy.com/https://github.com/".insteadof "https://github.com/"
      log "Git mirror set: github.com -> mirror.ghproxy.com/https://github.com/";;
    unset)
      git config --global --unset-all url."https://gitclone.com/github.com/".insteadof || true
      git config --global --unset-all url."https://mirror.ghproxy.com/https://github.com/".insteadof || true
      log "Git mirrors unset.";;
    *) echo "Usage: set_git_mirror [gitclone|ghproxy|unset]"; return 2;;
  esac
}

function set_brew_mirror() {
  local site="${1:-bfsu}"
  case "$site" in
    tuna)
      export HOMEBREW_BOTTLE_DOMAIN="$BOTTLE_MIRRORS_TUNA"
      export HOMEBREW_BREW_GIT_REMOTE="$BREW_GIT_TUNA"
      export HOMEBREW_CORE_GIT_REMOTE="$CORE_GIT_TUNA";;
    ustc)
      export HOMEBREW_BOTTLE_DOMAIN="$BOTTLE_MIRRORS_USTC"
      export HOMEBREW_BREW_GIT_REMOTE="$BREW_GIT_USTC"
      export HOMEBREW_CORE_GIT_REMOTE="$CORE_GIT_USTC";;
    bfsu|default)
      export HOMEBREW_BOTTLE_DOMAIN="$BOTTLE_MIRRORS_BFSU"
      export HOMEBREW_BREW_GIT_REMOTE="$BREW_GIT_BFSU"
      export HOMEBREW_CORE_GIT_REMOTE="$CORE_GIT_BFSU";;
    *) echo "Usage: set_brew_mirror [tuna|ustc|bfsu]"; return 2;;
  esac
  log "Homebrew mirrors: BOTTLE=$HOMEBREW_BOTTLE_DOMAIN"
  log "Homebrew BREW_GIT=$HOMEBREW_BREW_GIT_REMOTE"
  log "Homebrew CORE_GIT=$HOMEBREW_CORE_GIT_REMOTE"
}

function show_brew_env() {
  env | grep -E 'HOMEBREW_(BOTTLE_DOMAIN|BREW_GIT_REMOTE|CORE_GIT_REMOTE)' || true
}

function npm_mirror_set() {
  local registry="${1:-https://registry.npmmirror.com}"
  npm config set registry "$registry"
  log "npm registry set: $(npm config get registry)"
}

function npm_mirror_unset() {
  npm config delete registry
  log "npm registry restored: $(npm config get registry)"
}

function usage() {
  cat <<'EOF'
xget-local – 国内镜像源本地真实使用版本（不依赖 Cloudflare）

命令：
  xget_download <url> [dest]         使用 GHProxy 前缀加速下载，失败回源
  xget_clone <repo_url> [args...]    通过 gitclone 加速克隆
  set_git_mirror [gitclone|ghproxy|unset]
  set_brew_mirror [tuna|ustc|bfsu]   设置 Homebrew 镜像相关环境变量（非持久）
  show_brew_env                      查看当前 Homebrew 镜像环境变量
  npm_mirror_set [registry_url]      设置 npm registry（默认 npmmirror）
  npm_mirror_unset                   恢复 npm registry

示例：
  bash xget-local -c 'xget_download https://github.com/cli/cli/releases/download/v2.53.0/gh_2.53.0_macOS_amd64.tar.gz gh.tar.gz'
  bash xget-local -c 'set_brew_mirror bfsu && show_brew_env'
  bash xget-local -c 'xget_clone https://github.com/Homebrew/brew.git'
EOF
}

if [[ "${1:-}" == "-c" ]]; then
  shift
  eval "$*"
else
  usage
fi
